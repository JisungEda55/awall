<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallpaper Maker</title>

<style>
body{
  margin:0;
  background:#f2f2f2;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-family:sans-serif;
  color:#111;
}

#canvasWrapper{
  width:100%;
  max-width:500px;
  aspect-ratio:1440/3120;
  background:white;
}

canvas{
  width:100%;
  height:100%;
  display:block;
}

#tools{
  width:100%;
  max-width:500px;
  background:#ffffff;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
  box-sizing:border-box;
  border-top:1px solid #ddd;
}

input, button{
  padding:10px;
  font-size:16px;
}

label{
  font-size:14px;
}
</style>
</head>
<body>

<div id="canvasWrapper">
  <canvas id="canvas" width="1440" height="3120"></canvas>
</div>

<div id="tools">
  <input type="file" id="imageInput" accept="image/*">
  <input type="text" id="textInput" placeholder="텍스트 입력">
  <button onclick="addText()">텍스트 추가</button>

  <label>D-Day 날짜 설정</label>
  <input type="date" id="ddayInput">

  <label>
    <input type="checkbox" id="toggleProgress">
    Progress Bar 표시
  </label>

  <button onclick="render()">다시 그리기</button>
  <button onclick="saveImage()">저장</button>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let currentImage = null;
let texts = [];
let startDate = new Date(); // 오늘 기준 시작

function clearCanvas(){
  ctx.fillStyle = "white";
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

document.getElementById("imageInput").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(event){
    const img = new Image();
    img.onload = function(){
      currentImage = img;
      render();
    }
    img.src = event.target.result;
  }
  reader.readAsDataURL(file);
});

function addText(){
  const value = document.getElementById("textInput").value;
  if(!value) return;
  texts.push(value);
  document.getElementById("textInput").value="";
  render();
}

function drawProgressBar(){
  const targetStr = document.getElementById("ddayInput").value;
  if(!targetStr) return;

  const now = new Date();
  const target = new Date(targetStr);

  const total = target - startDate;
  const current = now - startDate;

  let progress = current / total;
  if(progress < 0) progress = 0;
  if(progress > 1) progress = 1;

  const barWidth = canvas.width * 0.8;
  const barHeight = 40;
  const x = (canvas.width - barWidth)/2;
  const y = canvas.height - 200;

  // 배경 바
  ctx.fillStyle = "#ddd";
  ctx.fillRect(x, y, barWidth, barHeight);

  // 진행 바
  ctx.fillStyle = "#4caf50";
  ctx.fillRect(x, y, barWidth * progress, barHeight);

  // 텍스트
  const diffDays = Math.ceil((target - now)/(1000*60*60*24));
  ctx.fillStyle = "#111";
  ctx.font = "bold 40px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText(
    diffDays >= 0 ? "D-" + diffDays : "D+" + Math.abs(diffDays),
    canvas.width/2,
    y - 40
  );
}

function render(){
  clearCanvas();

  // 이미지 중앙 배치
  if(currentImage){
    const maxWidth = canvas.width * 0.8;
    const scale = maxWidth / currentImage.width;
    const imgWidth = currentImage.width * scale;
    const imgHeight = currentImage.height * scale;

    const x = (canvas.width - imgWidth)/2;
    const y = (canvas.height - imgHeight)/2 - 300;

    ctx.drawImage(currentImage, x, y, imgWidth, imgHeight);

    // 텍스트 여러 줄
    ctx.fillStyle = "#111";
    ctx.textAlign = "center";
    ctx.font = "bold 70px sans-serif";

    let textY = y + imgHeight + 120;
    texts.forEach(t=>{
      ctx.fillText(t, canvas.width/2, textY);
      textY += 120;
    });
  }

  // Progress Bar
  if(document.getElementById("toggleProgress").checked){
    drawProgressBar();
  }
}

function saveImage(){
  const link = document.createElement("a");
  link.download="wallpaper.png";
  link.href=canvas.toDataURL("image/png");
  link.click();
}

render();
</script>

</body>
</html>